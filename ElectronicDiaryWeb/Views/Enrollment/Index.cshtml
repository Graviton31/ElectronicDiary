@model List<ElectronicDiaryApi.Models.Subject>

<h2>Предметы</h2>
<ul id="subjectList">
    @foreach (var subject in Model)
    {
        <li>
            <a href="#" class="subject-link" data-id="@subject.IdSubject">@subject.Name</a>
        </li>
    }
</ul>

<div id="groupContainer" style="display:none;">
    <h2>Группы</h2>
    <ul id="groupList"></ul>
</div>

<div id="requestContainer" style="display:none;">
    <h2>Заявки</h2>
    <table id="requestTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Дата заявки</th>
                <th>Статус</th>
                <th>Комментарий</th>
                <th>Студент</th>
                <th>Группа</th>
                <th>Предмет</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.subject-link').click(function (e) {
                e.preventDefault();
                var subjectId = $(this).data('id');
                $.get('/Enrollment/GetGroups?subjectId=' + subjectId, function (groups) {
                    $('#groupList').empty();
                    groups.forEach(function (group) {
                        $('#groupList').append('<li><a href="#" class="group-link" data-id="' + group.idGroup + '">' + group.name + '</a> (Текущие студенты: ' + group.currentStudentCount + ', Максимум: ' + group.maxStudentCount + ')</li>');
                    });
                    $('#groupContainer').show();
                });
            });

            $(document).on('click', '.group-link', function (e) {
                e.preventDefault();
                var groupId = $(this).data('id');
                $.get('/Enrollment/GetRequests?groupId=' + groupId, function (requests) {
                    $('#requestTable tbody').empty();
                    requests.forEach(function (request) {
                        $('#requestTable tbody').append('<tr><td>' + request.idRequest + '</td><td>' + new Date(request.requestDate).toLocaleDateString() + '</td><td>' + request.status + '</td><td>' + request.comment + '</td><td>' + request.studentFullName + '</td><td>' + request.groupName + '</td><td>' + request.subjectName +                         '</td><td><form method="post" action="/Enrollment/UpdateRequest">' +
                            '<input type="hidden" name="id" value="' + request.idRequest + '" />' +
                            '<select name="status">' +
                                '<option value="ожидает" ' + (request.status === "ожидает" ? "selected" : "") + '>Ожидает</option>' +
                                '<option value="одобрено" ' + (request.status === "одобрено" ? "selected" : "") + '>Одобрено</option>' +
                                '<option value="отклонено" ' + (request.status === "отклонено" ? "selected" : "") + '>Отклонено</option>' +
                            '</select>' +
                            '<input type="text" name="comment" placeholder="Комментарий" value="' + request.comment + '" ' + (request.status !== "отклонено" ? "disabled" : "") + ' />' +
                            '<button type="submit">Обновить</button>' +
                        '</form></td></tr>');
                    });
                    $('#requestContainer').show();
                });
            });
        });
    </script>
}

